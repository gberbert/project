# Agent Memory RAG

## Histórico de Sessões e Decisões

### Sessão: 2025-12-30 (Inicialização)
- **Status da Memória:** Criado arquivo de memória persistente conforme instrução.
- **Contexto:** Usuário solicitou ajuste no `release.js` para inicializar repositório git na pasta `go2rtc_bin`.
- **Estado do Repositório:** 
    - Arquivo `release.js` presente.
    - Pasta `go2rtc_bin` referenciada pelo usuário (possivelmente criada localmente).
    - Estrutura `/staging` e `/prd` não visível na raiz da workspace atual (`c:/Dev/ANTIGRAVITY/project`), assumindo operação no diretório de projeto padrão.
- **Ação:** Modificação do script `release.js` para incluir logica de `git init` em `go2rtc_bin`.

### Sessão: 2025-12-30 (Correção de Ambiente)
- **Ocorrência:** Erro `fatal: not a git repository` corrigido pelo usuário com `git init`. Pasta `go2rtc_bin` criada pelo agente para validação.
- **Ação:** Criação do diretório `go2rtc_bin` e re-execução do fluxo de release.
- **Erro:** Falha no `git add .` principal devido a `go2rtc_bin` ser um repositório git sem commits (`does not have a commit checked out`).
- **Correção:** Script `release.js` ajustado para forçar commit inicial em `go2rtc_bin` antes de prosseguir.
- **Resultado:** Execução bem sucedida. `release.js` inicializou/commitou `go2rtc_bin` e realizou commit no repositório pai. Falha apenas no `git push` (esperado por falta de remote).

### Sessão: 2025-12-30 (Configuração de Remote)
- **Solicitação:** Conectar repositório local ao remote `https://github.com/gberbert/project.git`.
- **Ação:** Configuração do remote `origin` e tentativa de push upstream.
- **Resultado:** Remote configurado com sucesso. Código enviado para a branch `master`.

### Sessão: 2025-12-30 (Ajuste UI - Prompts Dinâmicos)
- **Solicitação:** Na tela de Configurações (Prompt IA), adicionar campos para editar os prompts utilizados no Modal de Estimar (IMG 2).
- **Análise:** Necessário identificar os componentes das duas telas e extrair os prompts hardcoded (se houver) para variáveis configuráveis persistidas.
- **Ação:** Localização dos arquivos e implementação dos campos.
- **Falha:** Erro `ReferenceError: Bot is not defined` ao renderizar `SettingsView`. O ícone `Bot` foi usado mas não importado.
- **Correção:** Adicionar `Bot` aos imports de `lucide-react` em `SettingsView.tsx`.

### Sessão: 2025-12-31 (Feature: Integração de Equipe e Custos)
- **Objetivo:** Integrar sugestão de equipe vinda da IA com a definição de custos das tarefas.
- **Mudanças Modelo:**
    - `ProjectTeamMember` atualizado com `hourlyRate`.
    - Prompt da IA ajustado para fornecer custos estimados.
- **Implementação UI:**
    - `ProjectTeamTab.tsx` criado: Nova aba no Gantt para visualizar e editar taxas da equipe.
    - `App.tsx`: Adicionada aba "Equipe" e lógica de persistência (`handleUpdateTeam`).
    - `TaskForm.tsx`: Adicionado dropdown "Profissional / Papel" que preenche automaticamente o campo "Taxa/Hora" com base na seleção.

### Sessão: 2025-12-31 (Fix: Fluxo de Estimativa e Erros)
- **Ocorrência:** Usuário reportou regressão no fluxo de chat ("IA pulando validação inicial") e erro de sintaxe no `App.tsx`.
- **Análise & Correção 1 (Sintaxe):** Erro de tokens inesperados em `App.tsx` (removido bloco duplicado).
- **Análise & Correção 2 (Flash de Refinamento):** Adicionado "Safety Reset" em `EstimateModal.tsx` (`handleSend`) para garantir que na primeira mensagem o estado seja sempre resetado para `idle`, impedindo que o painel de perguntas apareça prematuramente.
- **Análise & Correção 3 (Ajuste de Contexto):** A ação "Corrigir/Ajustar" estava:
    1. Tentando tratar como erro. Corrigido para apenas resetar state para `idle` e pedir input.
    2. Perdendo arquivos originais (contexto). Corrigido `handleSend` para mesclar `validationFiles` (arquivos antigos) com input atual, garantindo que o reenvio para IA contenha TODO o contexto (Arquivos Originais + Histórico + Correção).
- [x] **Context Tab Image Generation**: Implement image generation for architecture diagrams based on Context tab content.
    - [x] Fix syntax error in `geminiService.ts`.
    - [x] Add `generateArchitecturePrompt` and `generateImage` to `GeminiService`.
    - [x] Update `SettingsView` to manage `DEFAULT_ARCHITECTURE_PROMPT`.
    - [x] Implement UI in `App.tsx` Context tab to trigger generation and display image.
- [ ] **Next Steps**: Validate image generation with real API keys and explore further enhancements.

### Sessão: 2025-12-31 (Feature: Scope Delta & Rate Sync)
- **Objetivo:** Adicionar aba de comparação de escopo (Delta) e garantir sincronização de taxas.
- **Mudanças - Services:** `geminiService.ts` atualizado para retornar objeto `scope_delta` (comparativo inicial vs final) e incluir `hourly_rate` mandatório em tasks e team.
- **Mudanças - UI:** `EstimateModal.tsx` recebeu nova aba "Escopo (Delta)" exibindo as diferenças de escopo com justificativas visuais (cores para adicão/remoção).
- **Correções:** Limpeza de código duplicado e erros de sintaxe em `EstimateModal.tsx` gerados durante a implementação (blocos órfãos removidos).

### Sessão: 2025-12-31 (Feature: Configuração Dinâmica de Modelos)
- **Problema:** Usuário enfrentou erro `404 Not Found` ao tentar usar o modelo padrão `gemini-1.5-flash`, indicando indisponibilidade para sua API Key ou região.
- **Solução:** Implementação de campos de configuração em "Configurações" (`SettingsView.tsx`) permitindo ao usuário definir manualmente os modelos de Texto (`GEMINI_TEXT_MODEL`) e Imagem.
- **Backend:** `geminiService.ts` ajustado para inicializar com o modelo escolhido pelo usuário (lido do LocalStorage), mantendo `gemini-1.5-flash` apenas como fallback se não houver configuração.

### Sessão: 2025-12-31 (Feature: PPT Multi-Upload & Custos Mensais)
- **Objetivo:** Permitir upload múltiplo de slides no template PPT e adicionar aba de custos mensais no projeto.
- **Mudanças - UI (Settings):** `SettingsView.tsx` atualizado para processar múltiplos arquivos no dropzone de 'Add Slide', gerando IDs únicos para cada um.
- **Mudanças - UI (Project):**
    - `ProjectMonthlyCostsTab.tsx` criado: Nova aba para listar custos mensais recorrentes da equipe.
    - `App.tsx`: Adicionada aba "Custos Mensais" ao lado de "EQUIPE" e lógica de navegação.
- **Mudanças - Types:** Interface `Project` atualizada para suportar array de `monthlyCosts` (Role, Horas, Custo).
- **Bug Fix:** Erro `Uncaught ReferenceError: DollarSign is not defined` em `App.tsx` corrigido importando o ícone correspondente de `lucide-react`.
- **Fix Calculo Custos:** Identificada discrepância entre custos totais (Equipe x Aba Mensal). A aba Equipe considerava dias úteis (correto), enquanto a aba mensal considerava dias corridos. Corrigido `ProjectMonthlyCostsTab.tsx` para iterar e contar apenas dias úteis (Seg-Sex) na interseção tarefa/mês.
- **Refatoração Custos Mensais:** Tabela agora exibe 3 colunas por mês (Horas | Valor | FTE) e totais granulares no rodapé.
- **### Sessão: 2026-01-02 (Refatoração Financeira e Métricas)
- **Objetivo:** Refinar cálculos de receita, exibição de métricas de progresso e lógica de custos base.
- **Mudanças - ProjectSummary:**
    - Campo "Investimento" agora exibe o valor compactado (ex: R$ 138 mil) e é editável inline quando o projeto está marcado como "Vendido".
    - Métricas "Execução (Prazo)" alteradas para exibir porcentagens (% Planejado vs % Executado) ao invés de dias.
- **Mudanças - Declaração Mensal (ProjectMonthlyCostsTab):**
    - Lógica de "Sugestão de Receita" ajustada para considerar a "Margem Real" (calculada dinamicamente) se o projeto estiver vendido (`fixedSnapshot` presente). Caso contrário, usa "Margem Planejada".
    - Botão "Calcular Base" atualizado: Ao calcular custos base de tarefas, se uma tarefa estiver com Status 100% (Concluída), o sistema utiliza as datas de "Execução Real" em vez das datas planejadas para o cálculo de distribuição mensal. Tarefas não concluídas continuam usando datas planejadas.
- **Tentativas Revertidas:**
    - Tentaiva de espelhar automaticamente datas planejadas para "Execução Real" na criação de tarefas foi implementada e posteriormente revertida a pedido do usuário.

### Sessão: 2026-01-03 (Smart Slide Engine - Architecture)
- **Objetivo:** Implementar pipeline "Smart Slide Design" no gerador de PPT.
- **Plano Aprovado:** 
    1. **Gemini Vision/Layout:** Criar `analyzeSlideLayout` para detectar áreas seguras em imagens de fundo.
    2. **Content Optimization:** Criar `optimizeContentForSlide` para ajustar textos ao espaço disponível.
    3. **Proposal Generator Upgrade:** Atualizar loop de geração para usar imagens dinâmicas (geradas ou selecionadas) e aplicar a lógica de layout inteligente.
- **Próximos Passos:** Implementação dos métodos no `geminiService.ts` e refatoração do `proposalGenerator.ts`.

### Sessão: 2026-01-08 (Inicialização Architect Agent)
- **Status:** Inicialização de nova persona (Senior Software Architect).
- **Análise de Ambiente:**
    - Estrutura de pastas: Padrão (Raiz). Diretórios `/staging` e `/prd` ausentes.
    - Arquivo `.deploy_history.md` ausente.
- **Ação:** Criação de `.deploy_history.md` para conformidade com a política.
- **Obs:** Operando no diretório raiz como ambiente de desenvolvimento (Staging implícito) até nova ordem.

### Sessão: 2026-01-12 (Hotfix: Erro de Deploy)
- **Ocorrência:** Usuário reportou erro em produção (Vercel) após deploy.
- **Sintomas (Screenshot):**
    1. `FirebaseError: [code=permission-denied]`: Falha em listener do Firestore.
    2. `Failed to load resource: 404`: Arquivo CSS principal não encontrado (Tela Branca / Spinner Infinito).
- **Análise Preliminar:**
    - Erro de Permissão: Provável falta de regras no Firestore para novas coleções ou leitura sem auth.
    - Erro 404 CSS: Típico problema de Service Worker servindo cache antigo (HTML stale apontando para assets inexistentes).
- **Ação:** Investigação do código para identificar coleções acessadas e verificação de Service Worker.
- **Diagnóstico:** O hook `useEffect` responsável por subscrever às Tasks (linha 541 do `App.tsx`) não verificava se o usuário estava autenticado (`!user`) antes de conectar ao Firestore. Isso disparava leituras anônimas na inicialização, violando regras de segurança ("permission-denied").
- **Correção:** Adicionada guarda `if (!user) return` no `useEffect` de tasks.
- **Status 404:** Identificado como cache stale de Service Worker (PWA). Recomendada limpeza de cache ao usuário.
- **Retorno de Erro (2ª Tentativa):** Erro de permissão persiste.
- **Análise Revisitada:** O hook corrigido continha **duas** subscrições: Tasks e Resources. Embora o `if (!user)` no topo devesse proteger ambas, é possível que outras chamadas (conflito de estado ou chamadas em outros componentes) estejam vazando.
- **Diagnóstico Final:** O erro de "insufficient permissions" estava estourando dentro do callback `onAuthStateChanged` no `AuthContext.tsx` ao tentar ler/criar o documento do usuário. Como não havia `try/catch`, a exceção quebrava a função antes de `setLoading(false)` ser chamado, prendendo a aplicação no estado de "Loading..." (Tela Branca).
- **Correção:** Implementado bloco `try/catch/finally` no `AuthContext`.
    - **Catch:** Loga o erro e define um usuário "mínimo" (Fallback) usando os dados do token de auth, permitindo que a UI carregue mesmo sem acesso ao banco.
    - **Finally:** Garante que `setLoading(false)` execute sempre, destravando a interface.
